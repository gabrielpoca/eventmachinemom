#!/usr/bin/env ruby

require 'eventmachinemom'

# make sure it terminates right to simulate a shutdown
trap("SIGINT") do
  if !ARGV[1].nil?
    Logger.dump_log_message ARGV[1]
  end
  exit!
end

hosts = [
  {host: '0.0.0.0', web: 8080, sync: 3000},
  {host: '0.0.0.0', web: 8081, sync: 3001},
  {host: '0.0.0.0', web: 8082, sync: 3002},
  {host: '0.0.0.0', web: 8083, sync: 3003},
][ARGV[0].to_i - 1]

if ARGV[0].eql? "1"
  EventMachineMOM::Server.all.each {|server| server.update_attributes!(active: false)}
end

EventMachineMOM::Application.new hosts[:host], hosts[:web], hosts[:sync], !ARGV[1].nil?
